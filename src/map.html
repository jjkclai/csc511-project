<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./assets/css/map.css">
</head>
<body>
    <div id="map-svg-container" class="svg-container">
        <svg id="map-svg" class="svg"></svg>
    </div>

    <div id="map-options-container" class="options-container">
        <input type="checkbox" id="grid-checkbox-b" class="checkbox"><label>Show Blue-side Grid</label>
        <input type="checkbox" id="grid-checkbox-r" class="checkbox"><label>Show Red-side Grid</label>
        <br>
        <input type="button" id="debug-button" class="button" value="Click me">
    <div>

<script>
    d3.csv("https://raw.githubusercontent.com/jkclai/csc511-project/master/src/assets/csv/2019-worlds.csv").then(function(rows) {
        window.data=rows;
    });

    window.mapSvg = d3.select("svg#map-svg");

    mapSvg.append("image")
        .attr("xlink:href", "./assets/images/minimap.png")
        .attr("width", "100%")
        .attr("height", "100%");
    
    d3.select("input#debug-button").on("click", function() {
        loadData("1070340");
    });

    function loadData(targetId) {
        const targetData = window.data.filter(d => d["gameid"] == targetId);
        visualize(targetData);
    }

    function visualize(data) {
        visualizeTeam(data);
        visualizePlayer(data);
    }

    function visualizeTeam(data) {
        const blueTeam = data.filter(d => d["side"] == "Blue");
        const redTeam = data.filter(d => d["side"] == "Red");

        mapSvg.append("text")
            .attr("id", blueTeam[0]["gameid"] + "-" + "blue")
            .attr("class", "team-text heavy-font")
            .attr("x", "15%")
            .attr("y", "85%")
            .attr("fill", "blue")
            .attr("dominant-baseline", "middle")
            .attr("text-anchor", "middle")
            .text(blueTeam[0]["team"]);
        
        mapSvg.append("text")
            .attr("id", redTeam[0]["gameid"] + "-" + "red")
            .attr("class", "team-text heavy-font")
            .attr("x", "85%")
            .attr("y", "15%")
            .attr("fill", "red")
            .attr("dominant-baseline", "middle")
            .attr("text-anchor", "middle")
            .text(redTeam[0]["team"]);
    }

    function visualizePlayer(data) {
        const blueTeam = data.filter(d => d["playerid"] == 100);
        const redTeam = data.filter(d => d["playerid"] == 200);
        const players = data.filter(d => d["playerid"] <= 10);

        players.sort(function(a, b) {
            if(a["totalgold"] > b["totalgold"]) {
                return 1;
            }
            else if(a["totalgold"] < b["totalgold"]) {
                return -1;
            }
            return 0;
        });

        mapSvg.selectAll("circle")
            .data(players)
            .enter()
            .append("circle")
            .attr("id", function(d) {
                return d["gameid"] + "-" + d["side"].toLowerCase() + "-" + d["position"].toLowerCase();
            })
            .style("opacity", "0.75")
            .style("stroke", "black")
            .style("fill", function(d) {
                return d["side"];
            })
            .attr("cx", function(d) {
                return getIconPos(d)[0] + "%";
            })
            .attr("cy", function(d) {
                return (100 - getIconPos(d)[1]) + "%";
            })
            .attr("r", function(d) {
                return getIconRad(d, blueTeam, redTeam) + "%";
            });
    }

    function getIconPos(player) {
        const targetP1 = [14, 32, 50, 68, 86];

        const p = targetP1[(player["playerid"] - 1) % 5];
        return getIntersection([[0, 0], [p, (100 - p)]], getLineB(player));
    }

    function getIconRad(player, blueTeam, redTeam) {
        const pGold = player["totalgold"] - 0;
        const bGold = blueTeam[0]["totalgold"] - 0;
        const rGold = redTeam[0]["totalgold"] - 0;

        return 20 * (pGold / (bGold + rGold));
    }

    function getLineB(player) {
        function getBase(side) {
            if(side == "Blue") {
                return 45;
            }
            return 55;
        }

        function getDirection(side) {
            if(side == "Blue") {
                return 1;
            }
            return -1;
        }

        function getOffset(k, d, a) {
            return 2 * k + (-2) * d + 1 * a;
        }

        const p = getBase(player["side"]) + getDirection(player["side"]) * getOffset(player["k"], player["d"], player["a"]);

        return [[0, 2 * p], [2 * p, 0]];
    }

    function getIntersection(lineA, lineB) {
        xDiff = [(lineA[0][0] - lineA[1][0]), (lineB[0][0] - lineB[1][0])];
        yDiff = [(lineA[0][1] - lineA[1][1]), (lineB[0][1] - lineB[1][1])];

        function det(a, b) {
            return a[0] * b[1] - a[1] * b[0];
        }

        div = det(xDiff, yDiff);

        d = [det(lineA[0], lineA[1]), det(lineB[0], lineB[1])];
        x = det(d, xDiff) / div;
        y = det(d, yDiff) / div;

        return [x, y];
    }

    d3.select("input#grid-checkbox-b").on("change", function() {
        gridUpdate("b");
    });
    d3.select("input#grid-checkbox-r").on("change", function() {
        gridUpdate("r");
    });

    function gridUpdate(side) {
        if(d3.select("input#grid-checkbox-" + side).property("checked")){
            showGrid(side);
        } else {
            hideGrid(side);
        }
    }

    function showGrid(side) {
        const targetP1 = ["14%", "32%", "50%", "68%", "86%"];
        const targetX2 = (side == "b") ? "0%" : "100%";
        const targetY2 = (side == "b") ? "100%" : "0%";

        targetP1.forEach(function(item, index) {
            mapSvg.append("line")
                .attr("class", "map-grid-" + side + " dashed-line")
                .attr("x1", item)
                .attr("y1", item)
                .attr("x2", targetX2)
                .attr("y2", targetY2)
                .attr("stroke-width", 5)
                .attr("stroke", "white");
        });
    }
    
    function hideGrid(side) {
        d3.selectAll("line.map-grid-" + side).remove();
    }
</script>
</body>
</html>